import Head from 'next/head';
import { ArticleList } from '@/pages/components/ArticleList';

type Params = { [key: string]: string };

export type Article = {
  canonicalurl: string;
  displaytitle: string;
  extract: string;
  pageid: number;
  thumbnail?: { source: string };
};

type HomeProps = {
  articles: Article[];
};

export async function getRandomArticleIds(): Promise<number[]> {
  const randomQueryParams: Params = {
    action: 'query',
    format: 'json',
    list: 'random',
    rnnamespace: '0',
    rnlimit: '10',
  };
  const params = new URLSearchParams(randomQueryParams).toString();
  const url = 'https://en.wikipedia.org/w/api.php?origin=*&' + params;
  const randomData = await fetch(url).then((res) => res.json());

  return randomData.query.random.map((article: { id: number }) => article.id);
}

export async function getArticleInfoFromIds(
  articleIds: number[]
): Promise<Article[]> {
  const infoQueryParams: Params = {
    action: 'query',
    format: 'json',
    exintro: 'true',
    explaintext: 'true',
    inprop: 'url|displaytitle|preload',
    pageids: articleIds.join('|'),
    pithumbsize: '150',
    prop: 'extracts|pageimages|info',
    redirects: '1',
  };
  const params = new URLSearchParams(infoQueryParams).toString();
  const url = 'https://en.wikipedia.org/w/api.php?origin=*&' + params;
  const articleData = await fetch(url).then((res) => res.json());

  return Object.values(articleData.query.pages);
}

export async function getRandomArticleInfo() {
  const randomArticleIds = await getRandomArticleIds();
  return getArticleInfoFromIds(randomArticleIds);
}

export async function getServerSideProps() {
  return {
    props: { articles: await getRandomArticleInfo() },
  };
}

export default function Home({ articles }: HomeProps) {
  return (
    <>
      <Head>
        <title>Wikipedia Infinite Scroll</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <ArticleList articles={articles} />
    </>
  );
}
